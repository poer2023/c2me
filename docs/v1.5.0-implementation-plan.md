# ChatCode Desktop v1.5.0 Implementation Plan

## Overview
Implement new features and bug fixes for the ChatCode Desktop application.

## Tasks

### 1. Settings Page Refactoring
**Current State**: Configuration is embedded in main App.tsx as a tab
**Target**: Separate Settings page component

**Files to Modify/Create:**
- `desktop/src/components/SettingsPage.tsx` (new)
- `desktop/src/App.tsx` (refactor)
- `desktop/src/App.css` (add settings styles)

**Implementation:**
- Extract Configuration tab content to new `SettingsPage` component
- Add Settings icon/button in header for quick access
- Keep ability to show Settings as overlay or separate route

---

### 2. Dark/Light Mode Toggle
**Current State**: Uses `@media (prefers-color-scheme: dark)` (system follows only)
**Target**: Manual toggle with 3 options: System, Light, Dark

**Files to Modify/Create:**
- `desktop/src/contexts/ThemeContext.tsx` (new)
- `desktop/src/App.tsx` (wrap with ThemeProvider)
- `desktop/src/App.css` (add `.theme-light`, `.theme-dark` classes)
- `desktop/src/components/SettingsPage.tsx` (add theme toggle)

**Implementation:**
```tsx
type Theme = 'system' | 'light' | 'dark';
// Store in localStorage, apply class to body
```

---

### 3. i18n (Chinese/English Toggle)
**Target**: Support English and Chinese languages

**Files to Create:**
- `desktop/src/i18n/index.ts` (i18n setup)
- `desktop/src/i18n/locales/en.json`
- `desktop/src/i18n/locales/zh.json`
- `desktop/src/contexts/LanguageContext.tsx`

**Implementation:**
- Use simple i18n approach (no heavy library)
- Store preference in localStorage
- Wrap app with LanguageProvider
- Add language toggle in Settings

---

### 4. BUG FIX: TOOL USAGE Shows 0
**Root Cause**: `tool_approvals` and `tool_rejections` counters are defined but **NEVER incremented**

**Files to Modify:**
- `src/handlers/telegram/callbacks/callback-handler.ts` - Add increment calls when tools are approved/rejected

**Fix:**
```typescript
// In callback handler when user approves a tool:
incrementCounter('tool_approvals');

// When user rejects:
incrementCounter('tool_rejections');
```

---

### 5. Telegram Message Simulator Page
**Target**: New page that displays bot messages in Telegram-style UI

**Files to Create:**
- `desktop/src/components/MessageSimulator.tsx` (new)
- Add styles for Telegram message bubbles

**Implementation:**
- Parse logs to extract Telegram-style messages
- Create message bubble components (sent/received)
- Show real-time updates from bot-log events
- Display markdown/code formatting like Telegram

---

### 6. BUG FIX: processing(0s) Not Updating
**Root Cause Investigation**:
- Looking at `session-progress.ts`, the `buildStatusText()` correctly calculates elapsed time
- The issue is likely the `statusUpdateInterval` (5000ms default) combined with `minEditInterval` (3000ms)
- BUT: The first edit happens in `start()` which calls `sendHeartbeat()` only, not `updateStatusMessage()`

**Files to Modify:**
- `src/utils/session-progress.ts`

**Fix:**
```typescript
// In start() method, after startIntervals():
// Update message immediately with correct time
await this.updateStatusMessage();
```

---

## Priority Order
1. Bug fixes (TOOL USAGE, processing 0s) - Critical
2. Settings Page - Required for other features
3. Dark/Light Mode Toggle - User requested
4. i18n Support - User requested
5. Message Simulator - Nice to have

## Verification
1. Build desktop app: `cd desktop && pnpm run build`
2. Run backend: `pnpm run dev`
3. Test TOOL USAGE metrics appear when tools are approved/rejected
4. Test processing time updates from 0s to actual elapsed time
5. Test theme toggle persists across app restarts
6. Test language toggle works correctly
7. Test message simulator displays logs in Telegram format
